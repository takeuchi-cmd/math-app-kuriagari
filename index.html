<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¹°ã‚Šä¸ŠãŒã‚Šè¶³ã—ç®—ãƒãƒ£ãƒ¬ãƒ³ã‚¸</title>
    <!-- Tailwind CSS CDNã®èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Interãƒ•ã‚©ãƒ³ãƒˆã®è¨­å®š -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* ä¸Šéƒ¨ã«å¯„ã›ã‚‹ */
            min-height: 100vh;
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        /* æ­£è§£æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        @keyframes correct-flash {
            0% { transform: scale(1); opacity: 1; background-color: #22c55e; }
            50% { transform: scale(1.1); opacity: 0.8; background-color: #4ade80; }
            100% { transform: scale(1); opacity: 1; background-color: #22c55e; }
        }
        .flash-correct {
            animation: correct-flash 0.3s ease-out;
        }
        /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å¼·åŒ– */
        .animate-bounce {
            animation: bounce 0.6s infinite alternate;
        }
        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-10px); }
        }
    </style>
</head>
<body class="bg-gray-50">

    <div id="app" class="w-full max-w-lg mx-4 bg-white p-6 md:p-10 rounded-xl shadow-2xl border border-blue-100">
        <h1 class="text-3xl font-bold text-center text-blue-600 mb-6">
            <span class="mr-2">â•</span> ç¹°ã‚Šä¸ŠãŒã‚Šè¶³ã—ç®—ãƒãƒ£ãƒ¬ãƒ³ã‚¸
        </h1>

        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="userInfoDisplay" class="text-sm text-gray-600 text-center mb-4">
            <p id="authStatus" class="text-xs text-red-500 mb-1">èªè¨¼ä¸­...</p>
            <p id="currentHandleName" class="text-base font-semibold text-gray-800 hidden">
                ã‚ˆã†ã“ã: <span class="text-blue-600" id="displayHandleName"></span>
            </p>
            <p id="currentUserId" class="text-xs mt-1 hidden">
                ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: <span class="font-mono text-gray-500 text-[10px]" id="displayUserId"></span>
            </p>
        </div>
        
        <!-- å…¨ä½“é€šçŸ¥ç”¨ã‚³ãƒ³ãƒ†ãƒŠ (çµæœè¡¨ç¤ºã®ä¸Šã«ã‹ã¶ã›ã‚‹) -->
        <div id="notificationOverlay" class="fixed inset-0 bg-black bg-opacity-30 z-50 hidden flex justify-center items-center pointer-events-none">
            <div id="celebrationMessage" class="bg-white p-8 rounded-2xl shadow-2xl text-center transform scale-150 transition-transform duration-500 pointer-events-auto opacity-0" style="min-width: 300px;">
                <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ãŒã“ã“ã«å…¥ã‚‹ -->
            </div>
        </div>


        <!-- ç”»é¢ã‚³ãƒ³ãƒ†ãƒŠ -->
        <div id="screenContainer">
            <!-- å„ç”»é¢ã¯JavaScriptã§åˆ‡ã‚Šæ›¿ãˆã‚‹ -->
        </div>
    </div>

    <!-- Firebase SDKã®èª­ã¿è¾¼ã¿ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, query, where, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’æœ‰åŠ¹ã«ã™ã‚‹
        setLogLevel('Debug');

        // =========================================================================
        // ã€é‡è¦ã€‘Firebase è¨­å®šæƒ…å ± - GitHub Pages å…¬é–‹ç”¨
        // =========================================================================
        // GitHub Pages ã§å‹•ã‹ã™ãŸã‚ã«ã¯ã€ä»¥ä¸‹ã® 'YOUR_...' ã®éƒ¨åˆ†ã‚’
        // å®Ÿéš›ã«ã‚ãªãŸãŒ Firebase ã§å–å¾—ã—ãŸæƒ…å ±ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚
        // =========================================================================
        const FIREBASE_CONFIG = {
  apiKey : "AIzaSyDQzOvJbWVS2HIPauMq5VXlLZrY_WvaEEw" , 
  authDomain : "math-app-kuriagari.firebaseapp.com" , 
  projectId : "math-app-kuriagari" , 
  storageBucket : "math-app-kuriagari.firebasestorage.app" , 
  messagingSenderId : "159625997232" , 
  appId : "1:159625997232:web:07e57c805d7045f84f8475" , 
  measurementId : "G-NTSYR8ZCSR" 
};
        // =========================================================================
        
        // ä»¥ä¸‹ã®å®šæ•°ã‚’ä½¿ã£ã¦ã€è¨­å®šãŒãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã®ã¾ã¾ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚
        // apiKeyãŒãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼æ–‡å­—åˆ—ã®æ®‹éª¸ã‚’å«ã‚“ã§ã„ã‚‹ã‹ã€ã¾ãŸã¯ç©ºæ–‡å­—åˆ—ã§ãªã„ã‹ã‚’ãƒã‚§ãƒƒã‚¯
        const IS_PLACEHOLDER_CONFIG = FIREBASE_CONFIG.apiKey.includes('****************') || FIREBASE_CONFIG.apiKey.length < 30;

        const appId = FIREBASE_CONFIG.projectId || 'default-app-id';

        let db, auth;
        let userId = null;
        let handleName = null;
        let isAuthReady = false;

        // UIè¦ç´ ã®å–å¾—
        const screenContainer = document.getElementById('screenContainer');
        const authStatusElement = document.getElementById('authStatus');
        const displayHandleNameElement = document.getElementById('displayHandleName');
        const displayUserIdElement = document.getElementById('displayUserId');
        const currentHandleNameElement = document.getElementById('currentHandleName');
        const currentUserIdElement = document.getElementById('currentUserId');
        const notificationOverlay = document.getElementById('notificationOverlay');
        const celebrationMessage = document.getElementById('celebrationMessage');


        // ã‚¢ãƒ—ãƒªã®çŠ¶æ…‹
        let startTime;
        let timerInterval;
        let currentQuestionIndex = 0;
        let questions = [];
        let records = []; // å€‹äººãƒ™ã‚¹ãƒˆãƒ»ãƒ‡ã‚¤ãƒªãƒ¼ãƒ™ã‚¹ãƒˆã®è¨ˆç®—ç”¨

        // Firestoreã®ãƒ‘ã‚¹å®šç¾©
        const USER_PROFILE_COLLECTION = 'user_profile';
        const USER_PROFILE_DOC_ID = 'settings';
        const PUBLIC_RECORDS_COLLECTION = 'addition_records';

        // --- 1. FirebaseåˆæœŸåŒ–ã¨èªè¨¼ ---
        async function initializeFirebase() {
            
            if (IS_PLACEHOLDER_CONFIG) {
                authStatusElement.textContent = "â—ã‚¨ãƒ©ãƒ¼: Firebaseè¨­å®šæƒ…å ±ãŒæœªè¨­å®šã§ã™ã€‚è¨˜éŒ²ã¯ä¿å­˜/èª­ã¿è¾¼ã¿ã•ã‚Œã¾ã›ã‚“ã€‚";
                // è¨­å®šãŒãªã„å ´åˆã¯ã‚µã‚¤ãƒ³ã‚¤ãƒ³å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
                isAuthReady = true;
                displayScreen(Screen.REGISTER);
                return;
            }

            try {
                // ã“ã“ã§initializeAppã‚’å®Ÿè¡Œã—ã€authã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ã™ã‚‹
                const app = initializeApp(FIREBASE_CONFIG);
                db = getFirestore(app);
                auth = getAuth(app);

                authStatusElement.textContent = "èªè¨¼ä¸­...";

                // å¤–éƒ¨ç’°å¢ƒã§ã¯ã‚«ã‚¹ã‚¿ãƒ èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã¯ä½¿ç”¨ã—ãªã„ã€‚åŒ¿åèªè¨¼ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã€‚
                await signInAnonymously(auth);
                
                // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        displayUserIdElement.textContent = userId;
                        currentUserIdElement.classList.remove('hidden');

                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆãƒãƒ³ãƒ‰ãƒ«ãƒãƒ¼ãƒ ï¼‰ã‚’èª­ã¿è¾¼ã‚€
                        await loadUserProfile();

                        authStatusElement.textContent = "èªè¨¼å®Œäº†";
                        authStatusElement.classList.add('hidden');
                        isAuthReady = true;

                        if (handleName) {
                            currentHandleNameElement.classList.remove('hidden');
                            displayScreen(Screen.HOME);
                            // è¨˜éŒ²ã®èª­ã¿è¾¼ã¿
                            loadRecordsAndDisplay();
                        } else {
                            displayScreen(Screen.REGISTER);
                        }

                    } else {
                        userId = null;
                        handleName = null;
                        isAuthReady = true;
                        authStatusElement.textContent = "æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦å‹•ä½œä¸­";
                        displayScreen(Screen.REGISTER);
                    }
                });

            } catch (error) {
                console.error("FirebaseåˆæœŸåŒ–ã¾ãŸã¯èªè¨¼ã‚¨ãƒ©ãƒ¼:", error);
                
                let errorMessage = `èªè¨¼ã‚¨ãƒ©ãƒ¼: ${error.code}`;
                
                if (error.code === 'auth/configuration-not-found') {
                    // auth/configuration-not-found ã®å ´åˆã¯ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ç™»éŒ²ã¾ãŸã¯è¨­å®šå€¤ã®ä¸ä¸€è‡´ã‚’æŒ‡æ‘˜
                    errorMessage = `èªè¨¼ã‚¨ãƒ©ãƒ¼: 'authDomain' ã¾ãŸã¯ Firebase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®šãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚`;
                } else if (error.code === 'auth/api-key-not-valid' || error.message.includes('api-key-not-valid')) {
                    errorMessage = `èªè¨¼ã‚¨ãƒ©ãƒ¼: APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚FIREBASE_CONFIGã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
                }

                authStatusElement.textContent = errorMessage;
            }
        }

        // --- 2. ç”»é¢åˆ‡ã‚Šæ›¿ãˆã¨UIæç”» ---
        const Screen = {
            REGISTER: 'register',
            HOME: 'home',
            PRACTICE: 'practice',
            RESULT: 'result',
            LEADERBOARD: 'leaderboard'
        };

        function displayScreen(screenName, data = null) {
            screenContainer.innerHTML = '';
            switch (screenName) {
                case Screen.REGISTER:
                    renderRegisterScreen();
                    break;
                case Screen.HOME:
                    renderHomeScreen();
                    break;
                case Screen.PRACTICE:
                    renderPracticeScreen();
                    break;
                case Screen.RESULT:
                    renderResultScreen(data);
                    break;
                case Screen.LEADERBOARD:
                    renderLeaderboardScreen();
                    break;
            }
        }

        // --- 3. Firestoreãƒ‡ãƒ¼ã‚¿æ“ä½œ (Handle Name) ---

        // ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãªè¨­å®šãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å‚ç…§ã‚’å–å¾—
        function getUserProfileDocRef(uid) {
            // Firestoreãƒ‘ã‚¹ã¯ /artifacts/{appId}/users/{userId}/user_profile/settings
            return doc(db, 'artifacts', appId, 'users', uid, USER_PROFILE_COLLECTION, USER_PROFILE_DOC_ID);
        }

        // ãƒãƒ³ãƒ‰ãƒ«ãƒãƒ¼ãƒ ã®èª­ã¿è¾¼ã¿
        async function loadUserProfile() {
            if (!userId || !isAuthReady) return;
            try {
                const docRef = getUserProfileDocRef(userId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    handleName = docSnap.data().handleName;
                    displayHandleNameElement.textContent = handleName;
                    currentHandleNameElement.classList.remove('hidden');
                }
            } catch (e) {
                console.error("ãƒãƒ³ãƒ‰ãƒ«ãƒãƒ¼ãƒ ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:", e);
            }
        }

        // ãƒãƒ³ãƒ‰ãƒ«ãƒãƒ¼ãƒ ã®ä¿å­˜
        async function saveHandleName(newHandleName) {
            if (!userId || !isAuthReady) return;
            try {
                const docRef = getUserProfileDocRef(userId);
                await setDoc(docRef, { handleName: newHandleName });
                handleName = newHandleName;
                displayHandleNameElement.textContent = handleName;
                currentHandleNameElement.classList.remove('hidden');
                displayScreen(Screen.HOME);
                loadRecordsAndDisplay();
            } catch (e) {
                console.error("ãƒãƒ³ãƒ‰ãƒ«ãƒãƒ¼ãƒ ã®ä¿å­˜ã«å¤±æ•—:", e);
                showNotification("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", 'error');
            }
        }

        // --- 4. Firestoreãƒ‡ãƒ¼ã‚¿æ“ä½œ (Records) ---

        // ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãªè¨˜éŒ²ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®å‚ç…§ã‚’å–å¾—
        function getPublicRecordsCollectionRef() {
            // Firestoreãƒ‘ã‚¹ã¯ /artifacts/{appId}/public/data/addition_records
            return collection(db, 'artifacts', appId, 'public', 'data', PUBLIC_RECORDS_COLLECTION);
        }

        // æ–°ã—ã„ç·´ç¿’è¨˜éŒ²ã®ä¿å­˜
        async function saveRecord(score, time) {
            if (!isAuthReady || !userId || !handleName) return;
            if (IS_PLACEHOLDER_CONFIG) {
                console.warn("Firebaseè¨­å®šãŒæœªè¨­å®šã®ãŸã‚ã€è¨˜éŒ²ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚");
                return false;
            }

            // Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰YYYY-MM-DDå½¢å¼ã‚’æ­£ã—ãå–å¾—
            const today = new Date().toISOString().slice(0, 10); 
            
            const recordData = {
                userId: userId,
                handleName: handleName,
                score: score, // ä»Šå›ã¯å¸¸ã«4
                time: parseFloat(time.toFixed(2)),
                timestamp: Timestamp.now(),
                date: today // ä¿®æ­£å¾Œã®æ—¥ä»˜
            };

            try {
                await addDoc(getPublicRecordsCollectionRef(), recordData);
                console.log("è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸ:", recordData);
                // è¨˜éŒ²ä¿å­˜å¾Œã€ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                await loadRecordsAndDisplay();
                return true;
            } catch (e) {
                console.error("è¨˜éŒ²ã®ä¿å­˜ã«å¤±æ•—:", e);
                showNotification("è¨˜éŒ²ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", 'error');
                return false;
            }
        }

        // è¨˜éŒ²ã®èª­ã¿è¾¼ã¿ã¨ãƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã®è¨ˆç®—
        async function loadRecordsAndDisplay() {
            if (!isAuthReady) return;
            if (IS_PLACEHOLDER_CONFIG) {
                console.warn("Firebaseè¨­å®šãŒæœªè¨­å®šã®ãŸã‚ã€è¨˜éŒ²ã¯èª­ã¿è¾¼ã¾ã‚Œã¾ã›ã‚“ã€‚");
                updateBestTimesDisplay(); // UIã‚’åˆæœŸå€¤ã§æ›´æ–°
                return;
            }
            try {
                // ã™ã¹ã¦ã®è¨˜éŒ²ã‚’èª­ã¿è¾¼ã‚€
                const q = query(getPublicRecordsCollectionRef());
                const querySnapshot = await getDocs(q);
                records = [];
                querySnapshot.forEach((doc) => {
                    records.push(doc.data());
                });

                // ãƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã‚’è¨ˆç®—ã—ã€ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¡¨ç¤ºã‚’æ›´æ–°
                updateBestTimesDisplay();

            } catch (e) {
                console.error("è¨˜éŒ²ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:", e);
                // å¤±æ•—ã—ã¦ã‚‚ã‚¢ãƒ—ãƒªã¯ç¶šè¡Œ
            }
        }

        function getBestTimes() {
            const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD

            let personalBest = Infinity;
            let dailyBest = Infinity;
            let dailyBestUser = null;
            
            // è¨˜éŒ²ãŒãªã„å ´åˆã¯åˆæœŸå€¤ã‚’è¿”ã™
            if (records.length === 0) {
                 return { personalBest: null, dailyBest: null, dailyBestUser: null };
            }

            records.forEach(record => {
                // å€‹äººãƒ™ã‚¹ãƒˆ (è‡ªåˆ†ã®è¨˜éŒ²ã®ã¿)
                if (record.userId === userId && record.time < personalBest) {
                    personalBest = record.time;
                }

                // ãƒ‡ã‚¤ãƒªãƒ¼ãƒ™ã‚¹ãƒˆ (ä»Šæ—¥ã®æ—¥ä»˜ã®è¨˜éŒ²å…¨ä½“)
                if (record.date === today && record.time < dailyBest) {
                    dailyBest = record.time;
                    dailyBestUser = record.handleName;
                }
            });

            return {
                personalBest: personalBest === Infinity ? null : personalBest,
                dailyBest: dailyBest === Infinity ? null : dailyBest,
                dailyBestUser: dailyBestUser
            };
        }

        function updateBestTimesDisplay() {
            const { personalBest, dailyBest, dailyBestUser } = getBestTimes();

            const pbElement = document.getElementById('personalBestTime');
            const dbElement = document.getElementById('dailyBestTime');
            const dbuElement = document.getElementById('dailyBestUser');

            if (pbElement) {
                pbElement.textContent = personalBest !== null ? `${personalBest.toFixed(2)} ç§’` : '---';
            }
            if (dbElement) {
                dbElement.textContent = dailyBest !== null ? `${dailyBest.toFixed(2)} ç§’` : '---';
            }
            if (dbuElement) {
                dbuElement.textContent = dailyBestUser !== null ? ` by ${dailyBestUser}` : '';
            }
        }
        
        // ãƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã®è¨ˆç®—é–¢æ•°ã‚’ã€ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºç”¨ã«æ‹¡å¼µ
        function getLeaderboardData() {
            // å…¨è¨˜éŒ²ã‚’ã‚¿ã‚¤ãƒ æ˜‡é †ã§ã‚½ãƒ¼ãƒˆ
            const sortedRecords = [...records].sort((a, b) => a.time - b.time);

            // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®ã‚»ãƒƒãƒˆã‚’ä½œæˆã—ã€å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã®ã¿ã‚’æŠ½å‡º
            const bestRecords = new Map();
            sortedRecords.forEach(record => {
                // åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§ã‚ã‚Œã°ã€æœ€åˆã«å‡ºã¦ããŸè¨˜éŒ²ï¼ˆï¼æœ€é€Ÿï¼‰ã®ã¿ã‚’ä¿æŒ
                if (!bestRecords.has(record.userId)) {
                    bestRecords.set(record.userId, record);
                }
            });

            // Mapã®å€¤ã‚’é…åˆ—ã«æˆ»ã—ã€å†åº¦ã‚¿ã‚¤ãƒ ã§ã‚½ãƒ¼ãƒˆã—ã¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã¨ã™ã‚‹
            const leaderboard = Array.from(bestRecords.values()).sort((a, b) => a.time - b.time);
            
            // æ—¥ä»˜ã‚’æ•´å½¢
            return leaderboard.map(record => ({
                rank: 0, // å¾Œã§è¨­å®š
                handleName: record.handleName,
                time: record.time.toFixed(2),
                // Firestoreã®Timestampã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’Dateã«å¤‰æ›ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã®æ—¥ä»˜æ–‡å­—åˆ—ã«å¤‰æ›
                date: record.timestamp?.toDate().toLocaleDateString('ja-JP') || '---' 
            }));
        }

        // --- 5. å•é¡Œç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ ---

        /**
         * ç¹°ã‚Šä¸ŠãŒã‚Šã®ã‚ã‚‹1æ¡åŒå£«ã®è¶³ã—ç®—å•é¡Œã‚’é‡è¤‡ãªã4å•ç”Ÿæˆã™ã‚‹
         * @returns {Array<{a: number, b: number, answer: number}>} 4å•ã®é…åˆ—
         */
        function generateQuestions() {
            const uniqueQuestions = [];
            const allCandidates = [];

            // ç¹°ã‚Šä¸ŠãŒã‚Šã®ã‚ã‚‹è¶³ã—ç®—ã®å€™è£œã‚’ã™ã¹ã¦ç”Ÿæˆ (A + B >= 10)
            for (let a = 1; a <= 9; a++) {
                for (let b = 1; b <= 9; b++) {
                    if (a + b >= 10) {
                        // é †ç•ªãŒç•°ãªã‚‹ã ã‘ã®é‡è¤‡ (ä¾‹: 7+8 ã¨ 8+7) ã‚’é¿ã‘ã‚‹ãŸã‚ã€A <= B ã®ã¿ã‚’æ¡ç”¨
                        if (a <= b) {
                            allCandidates.push({ a: a, b: b, answer: a + b });
                        }
                    }
                }
            }

            // å€™è£œæ•°ãŒ4æœªæº€ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼ï¼ˆãŸã ã—ã€å®Ÿéš›ã¯4å•ä»¥ä¸Šã‚ã‚‹ï¼‰
            if (allCandidates.length < 4) {
                 // ç™ºç”Ÿã—ãªã„ã¯ãšã ãŒå¿µã®ãŸã‚
                 return [ {a:5, b:5, answer:10}, {a:6, b:6, answer:12}, {a:7, b:7, answer:14}, {a:8, b:8, answer:16} ];
            }

            // å€™è£œãƒªã‚¹ãƒˆã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã€æœ€åˆã®4å•ã‚’é¸æŠ
            // Fisher-Yates (Knuth) Shuffle
            for (let i = allCandidates.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allCandidates[i], allCandidates[j]] = [allCandidates[j], allCandidates[i]];
            }

            // 4å•ã‚’ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªå•é¡Œã¨ã—ã¦é¸ã¶
            const selectedPairs = allCandidates.slice(0, 4);
            
            // æœ€å¾Œã«ã€Aã¨Bã®è¡¨ç¤ºé †ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å…¥ã‚Œæ›¿ãˆã¦ã€å•é¡Œã®è¦‹ãŸç›®ã‚’å¤šæ§˜ã«ã™ã‚‹
            return selectedPairs.map(q => {
                if (Math.random() < 0.5 && q.a !== q.b) {
                    return { a: q.b, b: q.a, answer: q.answer };
                }
                return q;
            });
        }


        // --- 6. ã‚¿ã‚¤ãƒãƒ¼ã¨ã‚²ãƒ¼ãƒ å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯ ---

        function startTimer() {
            startTime = performance.now();
            const timerElement = document.getElementById('timerDisplay');
            if (timerElement) {
                timerElement.textContent = '0.00 ç§’';
                clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    const elapsedTime = (performance.now() - startTime) / 1000;
                    timerElement.textContent = `${elapsedTime.toFixed(2)} ç§’`;
                }, 10); // 10ãƒŸãƒªç§’ã”ã¨ã«æ›´æ–°
            }
        }

        function stopTimer() {
            clearInterval(timerInterval);
            const endTime = performance.now();
            return (endTime - startTime) / 1000; // ç§’ã‚’è¿”ã™
        }

        async function nextQuestion() {
            const inputElement = document.getElementById('answerInput');
            const currentQuestion = questions[currentQuestionIndex];
            const userAnswer = parseInt(inputElement.value.trim());
            const feedbackElement = document.getElementById('feedbackMessage');
            
            // å…¥åŠ›ãƒã‚§ãƒƒã‚¯
            if (isNaN(userAnswer) || inputElement.value.trim() === '') {
                 feedbackElement.textContent = 'æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼';
                 feedbackElement.classList.remove('hidden');
                 return;
            }
            feedbackElement.classList.add('hidden');

            // æ­£èª¤åˆ¤å®š
            if (userAnswer === currentQuestion.answer) {
                // æ­£è§£ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¡¨ç¤º
                const questionBox = document.getElementById('questionBox');
                const nextButton = document.getElementById('nextButton');
                
                // æ­£è§£ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®é–‹å§‹
                questionBox.classList.add('flash-correct');
                
                // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                nextButton.disabled = true;
                nextButton.textContent = 'ã›ã„ã‹ã„ï¼ ğŸ‰';
                nextButton.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                nextButton.classList.add('bg-green-500');

                // ã‚ãšã‹ãªé…å»¶ã‚’è¨­ã‘ã¦ã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¦‹ã›ã‚‹
                await new Promise(resolve => setTimeout(resolve, 350));

                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒªã‚»ãƒƒãƒˆã¨ãƒœã‚¿ãƒ³ã®å¾©å…ƒ
                questionBox.classList.remove('flash-correct');
                nextButton.disabled = false;
                nextButton.textContent = 'è§£ç­”ã‚’ãƒã‚§ãƒƒã‚¯';
                nextButton.classList.remove('bg-green-500');
                nextButton.classList.add('bg-blue-500', 'hover:bg-blue-600');
                
                // æ¬¡ã®å•é¡Œã¸
                currentQuestionIndex++;
                inputElement.value = '';
                
                // 4å•å®Œäº†ã®ãƒã‚§ãƒƒã‚¯
                if (currentQuestionIndex >= 4) {
                    const finalTime = stopTimer();
                    const score = 4; // å¸¸ã«4å•æ­£è§£ã¨ã—ã¦æ‰±ã†
                    
                    // çµæœç”»é¢ã¸é·ç§»
                    displayScreen(Screen.RESULT, { score, time: finalTime });

                } else {
                    // æ¬¡ã®å•é¡Œã¸
                    renderPracticeQuestion();
                }

            } else {
                // ä¸æ­£è§£ï¼
                showNotification('ã¡ãŒã„ã¾ã™ï¼ã‚‚ã†ä¸€åº¦è€ƒãˆã¦ã¿ã¦ã­ã€‚', 'error');
                inputElement.value = ''; // å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
                inputElement.focus();
            }
        }

        function renderPracticeQuestion() {
            const questionElement = document.getElementById('questionText');
            const progressElement = document.getElementById('progressText');
            const inputElement = document.getElementById('answerInput');

            if (currentQuestionIndex < questions.length) {
                const q = questions[currentQuestionIndex];
                questionElement.innerHTML = `<span class="text-6xl font-extrabold text-gray-900">${q.a} + ${q.b}</span> =`;
                progressElement.textContent = `å•é¡Œ ${currentQuestionIndex + 1} / 4`;
                inputElement.focus();
            }
        }

        // --- 7. UIæç”»é–¢æ•° (å„ç”»é¢) ---

        // é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º (ç°¡æ˜“ç‰ˆ)
        function showNotification(message, type = 'success') {
            const feedback = document.getElementById('feedbackMessage');
            if (!feedback) return;
            feedback.textContent = message;
            feedback.classList.remove('hidden', 'text-green-600', 'text-red-600', 'text-yellow-600');

            if (type === 'error') {
                feedback.classList.add('text-red-600');
            } else if (type === 'warning') {
                feedback.classList.add('text-yellow-600');
            } else {
                 feedback.classList.add('text-green-600');
            }
            setTimeout(() => {
                feedback.classList.add('hidden');
            }, 3000);
        }
        
        // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ç‰¹åˆ¥ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        async function showCelebration(icon, title, subtitle) {
            // çµæœç”»é¢ã®æç”»å¾Œã€å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
            await new Promise(resolve => setTimeout(resolve, 50));

            notificationOverlay.classList.remove('hidden');
            celebrationMessage.innerHTML = `
                <div class="text-7xl mb-4 animate-bounce">${icon}</div>
                <h3 class="text-3xl font-extrabold text-pink-600 mb-2">${title}</h3>
                <p class="text-lg text-gray-700">${subtitle}</p>
            `;
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
            celebrationMessage.classList.remove('scale-150', 'opacity-0');
            celebrationMessage.classList.add('scale-100', 'opacity-100');

            // 2.5ç§’å¾Œã«è‡ªå‹•ã§éè¡¨ç¤º
            await new Promise(resolve => setTimeout(resolve, 2500));

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†
            celebrationMessage.classList.remove('scale-100', 'opacity-100');
            celebrationMessage.classList.add('scale-150', 'opacity-0');

            await new Promise(resolve => setTimeout(resolve, 500));
            notificationOverlay.classList.add('hidden');
        }


        // ç™»éŒ²ç”»é¢
        function renderRegisterScreen() {
            screenContainer.innerHTML = `
                <div class="text-center p-4">
                    <h2 class="text-2xl font-bold mb-4 text-blue-700">ã‚ˆã†ã“ãï¼ãƒãƒ³ãƒ‰ãƒ«ãƒãƒ¼ãƒ ã‚’ç™»éŒ²</h2>
                    <p class="mb-6 text-gray-600">è¨˜éŒ²ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã«ã€å¥½ããªåå‰ï¼ˆãƒãƒ³ãƒ‰ãƒ«ãƒãƒ¼ãƒ ï¼‰ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>
                    <input type="text" id="handleNameInput" placeholder="ä¾‹: ã•ã‚“ã™ã†ãƒã‚¹ã‚¿ãƒ¼" class="w-full p-3 border-2 border-blue-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg shadow-inner" maxlength="20">
                    <button id="registerButton" class="mt-6 w-full py-3 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-lg transition duration-200 shadow-md">
                        ç™»éŒ²ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆ
                    </button>
                    <p id="feedbackMessage" class="text-red-600 mt-3 hidden"></p>
                </div>
            `;
            document.getElementById('handleNameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('registerButton').click();
                }
            });
            document.getElementById('registerButton').addEventListener('click', () => {
                const input = document.getElementById('handleNameInput');
                const name = input.value.trim();
                if (name.length < 1) {
                    showNotification('ãƒãƒ³ãƒ‰ãƒ«ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
                    return;
                }
                saveHandleName(name);
            });
            
            // ä»¥å‰ã«å…¥åŠ›ãŒã‚ã‚Œã°åˆæœŸå€¤ã¨ã—ã¦è¨­å®š
            if (handleName) {
                document.getElementById('handleNameInput').value = handleName;
            }
        }

        // ãƒ›ãƒ¼ãƒ ç”»é¢
        function renderHomeScreen() {
            const { personalBest, dailyBest, dailyBestUser } = getBestTimes();

            screenContainer.innerHTML = `
                <div class="text-center p-4">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">æŒ‘æˆ¦ã‚’å¾…ã£ã¦ã„ã‚‹ã‚ˆï¼</h2>
                    
                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <!-- å€‹äººãƒ™ã‚¹ãƒˆ -->
                        <div class="bg-blue-50 p-4 rounded-xl shadow-lg border-l-4 border-blue-500">
                            <p class="text-sm font-semibold text-blue-700">ğŸ† å€‹äººã®æœ€é«˜ã‚¿ã‚¤ãƒ </p>
                            <p id="personalBestTime" class="text-3xl font-extrabold text-blue-900 mt-1">
                                ${personalBest !== null ? `${personalBest.toFixed(2)} ç§’` : '---'}
                            </p>
                        </div>
                        <!-- ãƒ‡ã‚¤ãƒªãƒ¼ãƒ™ã‚¹ãƒˆ -->
                        <div class="bg-yellow-50 p-4 rounded-xl shadow-lg border-l-4 border-yellow-500">
                            <p class="text-sm font-semibold text-yellow-700">ğŸŒŸ ä»Šæ—¥ã®æœ€é«˜ã‚¿ã‚¤ãƒ </p>
                            <p id="dailyBestTime" class="text-3xl font-extrabold text-yellow-900 mt-1">
                                ${dailyBest !== null ? `${dailyBest.toFixed(2)} ç§’` : '---'}
                            </p>
                            <p id="dailyBestUser" class="text-xs text-yellow-600 mt-1">
                                ${dailyBestUser !== null ? `by ${dailyBestUser}` : ''}
                            </p>
                        </div>
                    </div>

                    <button id="startButton" class="w-full py-4 bg-green-500 hover:bg-green-600 text-white text-xl font-bold rounded-xl transition duration-300 shadow-lg transform hover:scale-[1.02]">
                        ğŸ”¥ ç·´ç¿’ã‚¹ã‚¿ãƒ¼ãƒˆ (4å•)
                    </button>
                    
                    <!-- è¨˜éŒ²ä¸€è¦§ãƒœã‚¿ãƒ³ã‚’è¿½åŠ  -->
                    <button id="leaderboardButton" class="mt-4 w-full py-3 bg-indigo-500 hover:bg-indigo-600 text-white text-lg font-bold rounded-xl transition duration-300 shadow-lg transform hover:scale-[1.02]">
                        ğŸ“Š è¨˜éŒ²ä¸€è¦§ã‚’è¦‹ã‚‹
                    </button>
                    
                    <button id="changeNameButton" class="mt-4 w-full py-2 text-sm text-gray-500 hover:text-gray-700 transition duration-200">
                        ãƒãƒ³ãƒ‰ãƒ«ãƒãƒ¼ãƒ ã‚’å¤‰æ›´
                    </button>
                </div>
            `;
            document.getElementById('startButton').addEventListener('click', () => {
                questions = generateQuestions();
                currentQuestionIndex = 0;
                displayScreen(Screen.PRACTICE);
                startTimer();
            });
            document.getElementById('leaderboardButton').addEventListener('click', () => {
                displayScreen(Screen.LEADERBOARD);
            });
            document.getElementById('changeNameButton').addEventListener('click', () => {
                displayScreen(Screen.REGISTER);
            });
        }

        // ç·´ç¿’ç”»é¢
        function renderPracticeScreen() {
            screenContainer.innerHTML = `
                <div class="text-center p-4">
                    <p id="progressText" class="text-lg font-semibold text-blue-600 mb-6">å•é¡Œ 1 / 4</p>
                    
                    <!-- ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤º -->
                    <div class="bg-gray-100 p-3 rounded-lg shadow-inner mb-8">
                        <p class="text-sm text-gray-500">çµŒéæ™‚é–“</p>
                        <p id="timerDisplay" class="text-4xl font-mono font-bold text-gray-800">0.00 ç§’</p>
                    </div>

                    <!-- å•é¡Œè¡¨ç¤º -->
                    <div id="questionBox" class="flex justify-center items-center space-x-4 mb-8 bg-white p-4 rounded-xl border-2 border-transparent">
                        <span id="questionText" class="text-6xl font-extrabold text-gray-900"></span>
                        <input type="number" id="answerInput" class="w-28 p-4 text-4xl text-center border-4 border-blue-400 rounded-xl focus:ring-blue-600 focus:border-blue-600 shadow-lg transition duration-200" placeholder="ç­”ãˆ" inputmode="numeric">
                    </div>

                    <button id="nextButton" class="w-full py-3 bg-blue-500 hover:bg-blue-600 text-white text-xl font-bold rounded-xl transition duration-200 shadow-md">
                        è§£ç­”ã‚’ãƒã‚§ãƒƒã‚¯
                    </button>
                    
                    <p id="feedbackMessage" class="text-red-600 mt-4 text-sm font-semibold hidden"></p>
                    
                    <button id="stopButton" class="mt-4 py-2 text-sm text-gray-500 hover:text-red-500 transition duration-200">
                        é€”ä¸­ã§ã‚„ã‚ã‚‹
                    </button>
                </div>
            `;
            document.getElementById('answerInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('nextButton').click();
                }
            });
            document.getElementById('nextButton').addEventListener('click', nextQuestion);
            document.getElementById('stopButton').addEventListener('click', () => {
                stopTimer();
                currentQuestionIndex = 0;
                questions = [];
                displayScreen(Screen.HOME);
            });

            // æœ€åˆã®å•é¡Œã‚’æç”»
            renderPracticeQuestion();
        }

        // çµæœç”»é¢
        async function renderResultScreen({ score, time }) {
            
            // è¨˜éŒ²ã‚’å…ˆã«ä¿å­˜
            const isSaved = await saveRecord(score, time);
            
            // è¨˜éŒ²ä¿å­˜ã®`await`ãŒå®Œäº†ã—ã¦ã„ã‚‹ã®ã§ã€å†åº¦`getBestTimes`ã‚’å‘¼ã³å‡ºã—ã¦æœ€æ–°ã®ãƒ™ã‚¹ãƒˆã‚’ç¢ºèª
            const newBestTimes = getBestTimes();
            // isPersonalBestã¨isDailyBestã®åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¿®æ­£ã—ã€æœ€æ–°ã®ãƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã¨æ¯”è¼ƒ
            const isPersonalBest = newBestTimes.personalBest !== null && time <= newBestTimes.personalBest;
            // dailyBestUserãŒè‡ªåˆ†è‡ªèº«ã§ã€ã‹ã¤ã‚¿ã‚¤ãƒ ãŒãƒ‡ã‚¤ãƒªãƒ¼ãƒ™ã‚¹ãƒˆã¨åŒã˜ã‹é€Ÿã„å ´åˆ
            const isDailyBest = newBestTimes.dailyBest !== null && time <= newBestTimes.dailyBest && newBestTimes.dailyBestUser === handleName;

            // é”æˆçŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
            let messageTitle = 'ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼';
            let messageBody = `4å•ã‚’**${time.toFixed(2)}ç§’**ã§ã‚¯ãƒªã‚¢ï¼`;
            let messageIcon = 'ğŸ‘';
            
            // ã‚¹ã‚³ã‚¢ãŒ4ç‚¹ï¼ˆ100ç‚¹ï¼‰ã§ã‚ã‚Šã€ã‹ã¤ãƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã‚’æ›´æ–°ã—ãŸå ´åˆã«ã€ãŠç¥ã„ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            if (score === 4) { // 100ç‚¹ã®å ´åˆ
                if (isPersonalBest && isDailyBest) {
                    showCelebration('ğŸŒŸğŸ‘‘', 'ğŸ’¯ Wãƒ™ã‚¹ãƒˆé”æˆï¼ãŠã‚ã§ã¨ã†ï¼', 'å€‹äººã®æœ€é«˜è¨˜éŒ²ã¨ä»Šæ—¥ã®æœ€é«˜è¨˜éŒ²ã‚’åŒæ™‚ã«æ›´æ–°ã—ãŸã‚ˆï¼');
                    messageTitle = 'ğŸ‰ Wãƒ™ã‚¹ãƒˆé”æˆï¼ãŠã‚ã§ã¨ã†ï¼ ğŸ‰';
                    messageBody = `<span class="text-xl">ã™ã”ã™ãã‚‹ï¼æœ€é«˜ã®ã‚¿ã‚¤ãƒ ã§ãƒ€ãƒ–ãƒ«ãƒ™ã‚¹ãƒˆæ›´æ–°ï¼</span>`;
                    messageIcon = 'ğŸŒŸğŸ‘‘';
                } else if (isPersonalBest) {
                    showCelebration('ğŸš€', 'ğŸ’¯ è‡ªå·±ãƒ™ã‚¹ãƒˆæ›´æ–°ï¼', 'ã‚„ã£ãŸã­ï¼æœ€é«˜ã®ã‚¿ã‚¤ãƒ ã§è¨˜éŒ²ã‚’å¡—ã‚Šæ›¿ãˆãŸã‚ˆï¼');
                    messageTitle = 'ğŸ‘‘ è‡ªå·±ãƒ™ã‚¹ãƒˆæ›´æ–°ï¼ãŠã‚ã§ã¨ã†ï¼ ğŸ‘‘';
                    messageBody = `<span class="text-xl">ã‚„ã£ãŸã­ï¼æœ€é«˜ã®ã‚¿ã‚¤ãƒ ã§è¨˜éŒ²ã‚’å¡—ã‚Šæ›¿ãˆãŸã‚ˆï¼</span>`;
                    messageIcon = 'ğŸš€';
                } else if (isDailyBest) {
                    showCelebration('ğŸ¥‡', 'ğŸ’¯ ä»Šæ—¥ã®ãƒˆãƒƒãƒ—ã‚¹ã‚³ã‚¢ï¼', 'æœ€é«˜ã®ã‚¿ã‚¤ãƒ ã§ã‚¯ãƒ©ã‚¹ã®ãƒˆãƒƒãƒ—ã«ç«‹ã£ãŸã‚ˆï¼');
                    messageTitle = 'ğŸ† ä»Šæ—¥ã®ãƒˆãƒƒãƒ—ã‚¹ã‚³ã‚¢ï¼ ğŸ†';
                    messageBody = `<span class="text-xl">æœ€é«˜ã®ã‚¿ã‚¤ãƒ ã§ã‚¯ãƒ©ã‚¹ã®ãƒˆãƒƒãƒ—ã«ç«‹ã£ãŸã‚ˆï¼</span>`;
                    messageIcon = 'ğŸ¥‡';
                } else {
                    // 100ç‚¹ã ãŒãƒ™ã‚¹ãƒˆæ›´æ–°ã§ã¯ãªã„å ´åˆã‚‚ã€ç‰¹åˆ¥ã«ç¥ç¦
                    messageTitle = 'ğŸ‰ 100ç‚¹æº€ç‚¹ï¼ã™ã”ã„ï¼ ğŸ‰';
                    messageBody = `<span class="text-xl">å…¨å•æ­£è§£ï¼å®Œç’§ãªè§£ç­”ã§ã—ãŸï¼æ¬¡ã¯ã‚¿ã‚¤ãƒ æ›´æ–°ã ï¼</span>`;
                    messageIcon = 'ğŸ’¯';
                    // 100ç‚¹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å°‘ã—ã ã‘ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
                    showCelebration('ğŸ’¯', '100ç‚¹æº€ç‚¹ï¼', 'å…¨å•æ­£è§£ãŠã‚ã§ã¨ã†ï¼');
                }
            }
            
            screenContainer.innerHTML = `
                <div class="text-center p-6 bg-green-50 rounded-xl shadow-inner border-4 border-green-300">
                    <div class="text-6xl mb-4">${messageIcon}</div>
                    <h2 class="text-3xl font-extrabold mb-2 text-green-700">${messageTitle}</h2>
                    <p class="text-lg text-gray-600 mb-6">${messageBody}</p>

                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 inline-block">
                        <p class="text-sm font-semibold text-gray-500">ã‚ãªãŸã®ã‚¿ã‚¤ãƒ </p>
                        <p class="text-5xl font-extrabold text-green-600">${time.toFixed(2)} ç§’</p>
                        <p class="text-lg text-gray-700 mt-2">æ­£ç­”æ•°: ${score} / 4 å•</p>
                    </div>

                    <button id="backToHomeButton" class="mt-8 w-full py-3 bg-blue-500 hover:bg-blue-600 text-white text-lg font-bold rounded-xl transition duration-200 shadow-lg">
                        ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
                    </button>
                    ${!isSaved ? '<p class="text-red-500 mt-3 text-sm">â€»è¨˜éŒ²ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>' : ''}
                </div>
            `;
            document.getElementById('backToHomeButton').addEventListener('click', () => {
                displayScreen(Screen.HOME);
            });
        }
        
        // è¨˜éŒ²ä¸€è¦§ç”»é¢ (LEADERBOARD) ã‚’è¿½åŠ 
        function renderLeaderboardScreen() {
            const leaderboardData = getLeaderboardData();

            let listItems = '';
            if (leaderboardData.length > 0) {
                listItems = leaderboardData.map((record, index) => {
                    const rank = index + 1;
                    let rankDisplay = rank;
                    let rankClass = 'text-gray-600';
                    let highlight = '';

                    if (rank === 1) {
                        rankDisplay = 'ğŸ¥‡';
                        rankClass = 'text-yellow-600 font-extrabold';
                        highlight = 'bg-yellow-50 border-yellow-300';
                    } else if (rank === 2) {
                        rankDisplay = 'ğŸ¥ˆ';
                        rankClass = 'text-gray-500 font-extrabold';
                        highlight = 'bg-gray-100 border-gray-300';
                    } else if (rank === 3) {
                        rankDisplay = 'ğŸ¥‰';
                        rankClass = 'text-amber-700 font-extrabold';
                        highlight = 'bg-amber-100 border-amber-300';
                    }
                    
                    if (record.handleName === handleName && record.time === getBestTimes().personalBest?.toFixed(2)) {
                        highlight = highlight ? `${highlight} ring-2 ring-red-400` : 'bg-red-50 border-red-300 ring-2 ring-red-400';
                    }

                    return `
                        <li class="flex justify-between items-center p-3 rounded-lg border-b last:border-b-0 transition duration-150 ${highlight}">
                            <div class="flex items-center space-x-4">
                                <span class="text-xl w-8 text-center ${rankClass}">${rankDisplay}</span>
                                <div>
                                    <p class="text-lg font-semibold text-gray-800">${record.handleName}</p>
                                    <p class="text-xs text-gray-500">è¨˜éŒ²æ—¥: ${record.date}</p>
                                </div>
                            </div>
                            <span class="text-2xl font-mono font-bold text-indigo-600">${record.time} ç§’</span>
                        </li>
                    `;
                }).join('');
            } else {
                listItems = '<li class="text-center text-gray-500 py-8">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¸€ç•ªä¹—ã‚Šã‚’ç›®æŒ‡ãã†ï¼</li>';
            }

            screenContainer.innerHTML = `
                <div class="p-4">
                    <h2 class="text-2xl font-bold mb-6 text-indigo-700 text-center">ğŸ† ã‚¯ãƒ©ã‚¹ç·åˆãƒ©ãƒ³ã‚­ãƒ³ã‚° (ãƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒ )</h2>
                    
                    <ul class="bg-white rounded-xl shadow-lg border border-indigo-100 divide-y divide-gray-200">
                        ${listItems}
                    </ul>
                    
                    <button id="backFromLeaderboard" class="mt-8 w-full py-3 bg-blue-500 hover:bg-blue-600 text-white text-lg font-bold rounded-xl transition duration-200 shadow-lg">
                        ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
                    </button>
                </div>
            `;
            document.getElementById('backFromLeaderboard').addEventListener('click', () => {
                displayScreen(Screen.HOME);
            });
        }


        // --- 8. ã‚¢ãƒ—ãƒªã®èµ·å‹• ---
        initializeFirebase();

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸç”»é¢
        document.addEventListener('DOMContentLoaded', () => {
             // èªè¨¼å®Œäº†æ™‚ã«ç”»é¢ã¯åˆ‡ã‚Šæ›¿ã‚ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è¡¨ç¤º
             screenContainer.innerHTML = '<div class="text-center p-10"><p class="text-gray-500">ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¦ã„ã¾ã™...</p></div>';
        });

    </script>
</body>
</html>