<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¹°ã‚Šä¸ŠãŒã‚Šè¶³ã—ç®—ãƒãƒ£ãƒ¬ãƒ³ã‚¸</title>
    <!-- Tailwind CSS CDNã®èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Interãƒ•ã‚©ãƒ³ãƒˆã®è¨­å®š -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* ä¸Šéƒ¨ã«å¯„ã›ã‚‹ */
            min-height: 100vh;
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div id="app" class="w-full max-w-lg mx-4 bg-white p-6 md:p-10 rounded-xl shadow-2xl border border-blue-100">
        <h1 class="text-3xl font-bold text-center text-blue-600 mb-6">
            <span class="mr-2">â•</span> ç¹°ã‚Šä¸ŠãŒã‚Šè¶³ã—ç®—ãƒãƒ£ãƒ¬ãƒ³ã‚¸
        </h1>

        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="userInfoDisplay" class="text-sm text-gray-600 text-center mb-4">
            <p id="authStatus" class="text-xs text-red-500 mb-1">èªè¨¼ä¸­...</p>
            <p id="currentHandleName" class="text-base font-semibold text-gray-800 hidden">
                ã‚ˆã†ã“ã: <span class="text-blue-600" id="displayHandleName"></span>
            </p>
            <p id="currentUserId" class="text-xs mt-1 hidden">
                ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: <span class="font-mono text-gray-500 text-[10px]" id="displayUserId"></span>
            </p>
        </div>

        <!-- ç”»é¢ã‚³ãƒ³ãƒ†ãƒŠ -->
        <div id="screenContainer">
            <!-- å„ç”»é¢ã¯JavaScriptã§åˆ‡ã‚Šæ›¿ãˆã‚‹ -->
        </div>
    </div>

    <!-- Firebase SDKã®èª­ã¿è¾¼ã¿ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, query, where, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’æœ‰åŠ¹ã«ã™ã‚‹
        setLogLevel('Debug');

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®å®šç¾©ã¨åˆæœŸåŒ–
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;
        let handleName = null;
        let isAuthReady = false;

        // UIè¦ç´ ã®å–å¾—
        const screenContainer = document.getElementById('screenContainer');
        const authStatusElement = document.getElementById('authStatus');
        const displayHandleNameElement = document.getElementById('displayHandleName');
        const displayUserIdElement = document.getElementById('displayUserId');
        const currentHandleNameElement = document.getElementById('currentHandleName');
        const currentUserIdElement = document.getElementById('currentUserId');

        // ã‚¢ãƒ—ãƒªã®çŠ¶æ…‹
        let startTime;
        let timerInterval;
        let currentQuestionIndex = 0;
        let questions = [];
        let records = []; // å€‹äººãƒ™ã‚¹ãƒˆãƒ»ãƒ‡ã‚¤ãƒªãƒ¼ãƒ™ã‚¹ãƒˆã®è¨ˆç®—ç”¨

        // Firestoreã®ãƒ‘ã‚¹å®šç¾©
        const USER_PROFILE_COLLECTION = 'user_profile';
        const USER_PROFILE_DOC_ID = 'settings';
        const PUBLIC_RECORDS_COLLECTION = 'addition_records';

        // --- 1. FirebaseåˆæœŸåŒ–ã¨èªè¨¼ ---
        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                authStatusElement.textContent = "ã‚¨ãƒ©ãƒ¼: Firebaseè¨­å®šãŒã‚ã‚Šã¾ã›ã‚“";
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                authStatusElement.textContent = "èªè¨¼ä¸­...";

                // èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Œã°ä½¿ç”¨ã—ã€ãªã‘ã‚Œã°åŒ¿åèªè¨¼
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        displayUserIdElement.textContent = userId;
                        currentUserIdElement.classList.remove('hidden');

                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆãƒãƒ³ãƒ‰ãƒ«ãƒãƒ¼ãƒ ï¼‰ã‚’èª­ã¿è¾¼ã‚€
                        await loadUserProfile();

                        authStatusElement.textContent = "èªè¨¼å®Œäº†";
                        authStatusElement.classList.add('hidden');
                        isAuthReady = true;

                        if (handleName) {
                            currentHandleNameElement.classList.remove('hidden');
                            displayScreen(Screen.HOME);
                            // è¨˜éŒ²ã®èª­ã¿è¾¼ã¿
                            loadRecordsAndDisplay();
                        } else {
                            displayScreen(Screen.REGISTER);
                        }

                    } else {
                        userId = null;
                        handleName = null;
                        isAuthReady = true;
                        authStatusElement.textContent = "æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦å‹•ä½œä¸­";
                        displayScreen(Screen.REGISTER);
                    }
                });

            } catch (error) {
                console.error("FirebaseåˆæœŸåŒ–ã¾ãŸã¯èªè¨¼ã‚¨ãƒ©ãƒ¼:", error);
                authStatusElement.textContent = `èªè¨¼ã‚¨ãƒ©ãƒ¼: ${error.code}`;
            }
        }

        // --- 2. ç”»é¢åˆ‡ã‚Šæ›¿ãˆã¨UIæç”» ---
        const Screen = {
            REGISTER: 'register',
            HOME: 'home',
            PRACTICE: 'practice',
            RESULT: 'result'
        };

        function displayScreen(screenName, data = null) {
            screenContainer.innerHTML = '';
            switch (screenName) {
                case Screen.REGISTER:
                    renderRegisterScreen();
                    break;
                case Screen.HOME:
                    renderHomeScreen();
                    break;
                case Screen.PRACTICE:
                    renderPracticeScreen();
                    break;
                case Screen.RESULT:
                    renderResultScreen(data);
                    break;
            }
        }

        // --- 3. Firestoreãƒ‡ãƒ¼ã‚¿æ“ä½œ (Handle Name) ---

        // ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãªè¨­å®šãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å‚ç…§ã‚’å–å¾—
        function getUserProfileDocRef(uid) {
            return doc(db, 'artifacts', appId, 'users', uid, USER_PROFILE_COLLECTION, USER_PROFILE_DOC_ID);
        }

        // ãƒãƒ³ãƒ‰ãƒ«ãƒãƒ¼ãƒ ã®èª­ã¿è¾¼ã¿
        async function loadUserProfile() {
            if (!userId) return;
            try {
                const docRef = getUserProfileDocRef(userId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    handleName = docSnap.data().handleName;
                    displayHandleNameElement.textContent = handleName;
                    currentHandleNameElement.classList.remove('hidden');
                }
            } catch (e) {
                console.error("ãƒãƒ³ãƒ‰ãƒ«ãƒãƒ¼ãƒ ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:", e);
            }
        }

        // ãƒãƒ³ãƒ‰ãƒ«ãƒãƒ¼ãƒ ã®ä¿å­˜
        async function saveHandleName(newHandleName) {
            if (!userId) return;
            try {
                const docRef = getUserProfileDocRef(userId);
                await setDoc(docRef, { handleName: newHandleName });
                handleName = newHandleName;
                displayHandleNameElement.textContent = handleName;
                currentHandleNameElement.classList.remove('hidden');
                displayScreen(Screen.HOME);
                loadRecordsAndDisplay();
            } catch (e) {
                console.error("ãƒãƒ³ãƒ‰ãƒ«ãƒãƒ¼ãƒ ã®ä¿å­˜ã«å¤±æ•—:", e);
                showNotification("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", 'error');
            }
        }

        // --- 4. Firestoreãƒ‡ãƒ¼ã‚¿æ“ä½œ (Records) ---

        // ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãªè¨˜éŒ²ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®å‚ç…§ã‚’å–å¾—
        function getPublicRecordsCollectionRef() {
            return collection(db, 'artifacts', appId, 'public', 'data', PUBLIC_RECORDS_COLLECTION);
        }

        // æ–°ã—ã„ç·´ç¿’è¨˜éŒ²ã®ä¿å­˜
        async function saveRecord(score, time) {
            if (!isAuthReady || !userId || !handleName) return;

            const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
            
            const recordData = {
                userId: userId,
                handleName: handleName,
                score: score, // ä»Šå›ã¯å¸¸ã«4
                time: parseFloat(time.toFixed(2)),
                timestamp: Timestamp.now(),
                date: today
            };

            try {
                await addDoc(getPublicRecordsCollectionRef(), recordData);
                console.log("è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸ:", recordData);
                // è¨˜éŒ²ä¿å­˜å¾Œã€ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                await loadRecordsAndDisplay();
                return true;
            } catch (e) {
                console.error("è¨˜éŒ²ã®ä¿å­˜ã«å¤±æ•—:", e);
                showNotification("è¨˜éŒ²ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", 'error');
                return false;
            }
        }

        // è¨˜éŒ²ã®èª­ã¿è¾¼ã¿ã¨ãƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã®è¨ˆç®—
        async function loadRecordsAndDisplay() {
            if (!isAuthReady) return;
            try {
                // ã™ã¹ã¦ã®è¨˜éŒ²ã‚’èª­ã¿è¾¼ã‚€
                const q = query(getPublicRecordsCollectionRef());
                const querySnapshot = await getDocs(q);
                records = [];
                querySnapshot.forEach((doc) => {
                    records.push(doc.data());
                });

                // ãƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã‚’è¨ˆç®—ã—ã€ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¡¨ç¤ºã‚’æ›´æ–°
                updateBestTimesDisplay();

            } catch (e) {
                console.error("è¨˜éŒ²ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:", e);
                // å¤±æ•—ã—ã¦ã‚‚ã‚¢ãƒ—ãƒªã¯ç¶šè¡Œ
            }
        }

        function getBestTimes() {
            const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD

            let personalBest = Infinity;
            let dailyBest = Infinity;
            let dailyBestUser = null;
            
            // è¨˜éŒ²ãŒãªã„å ´åˆã¯åˆæœŸå€¤ã‚’è¿”ã™
            if (records.length === 0) {
                 return { personalBest: null, dailyBest: null, dailyBestUser: null };
            }

            records.forEach(record => {
                // å€‹äººãƒ™ã‚¹ãƒˆ (è‡ªåˆ†ã®è¨˜éŒ²ã®ã¿)
                if (record.userId === userId && record.time < personalBest) {
                    personalBest = record.time;
                }

                // ãƒ‡ã‚¤ãƒªãƒ¼ãƒ™ã‚¹ãƒˆ (ä»Šæ—¥ã®æ—¥ä»˜ã®è¨˜éŒ²å…¨ä½“)
                if (record.date === today && record.time < dailyBest) {
                    dailyBest = record.time;
                    dailyBestUser = record.handleName;
                }
            });

            return {
                personalBest: personalBest === Infinity ? null : personalBest,
                dailyBest: dailyBest === Infinity ? null : dailyBest,
                dailyBestUser: dailyBestUser
            };
        }

        function updateBestTimesDisplay() {
            const { personalBest, dailyBest, dailyBestUser } = getBestTimes();

            const pbElement = document.getElementById('personalBestTime');
            const dbElement = document.getElementById('dailyBestTime');
            const dbuElement = document.getElementById('dailyBestUser');

            if (pbElement) {
                pbElement.textContent = personalBest !== null ? `${personalBest.toFixed(2)} ç§’` : '---';
            }
            if (dbElement) {
                dbElement.textContent = dailyBest !== null ? `${dailyBest.toFixed(2)} ç§’` : '---';
            }
            if (dbuElement) {
                dbuElement.textContent = dailyBestUser !== null ? ` by ${dailyBestUser}` : '';
            }
        }

        // --- 5. å•é¡Œç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ ---

        /**
         * ç¹°ã‚Šä¸ŠãŒã‚Šã®ã‚ã‚‹1æ¡åŒå£«ã®è¶³ã—ç®—å•é¡Œã‚’é‡è¤‡ãªã4å•ç”Ÿæˆã™ã‚‹
         * @returns {Array<{a: number, b: number, answer: number}>} 4å•ã®é…åˆ—
         */
        function generateQuestions() {
            const uniqueQuestions = [];
            const allCandidates = [];

            // ç¹°ã‚Šä¸ŠãŒã‚Šã®ã‚ã‚‹è¶³ã—ç®—ã®å€™è£œã‚’ã™ã¹ã¦ç”Ÿæˆ (A + B >= 10)
            for (let a = 1; a <= 9; a++) {
                for (let b = 1; b <= 9; b++) {
                    if (a + b >= 10) {
                        // é †ç•ªãŒç•°ãªã‚‹ã ã‘ã®é‡è¤‡ (ä¾‹: 7+8 ã¨ 8+7) ã‚’é¿ã‘ã‚‹ãŸã‚ã€A <= B ã®ã¿ã‚’æ¡ç”¨
                        if (a <= b) {
                            allCandidates.push({ a: a, b: b, answer: a + b });
                        }
                    }
                }
            }

            // å€™è£œæ•°ãŒ4æœªæº€ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼ï¼ˆãŸã ã—ã€å®Ÿéš›ã¯4å•ä»¥ä¸Šã‚ã‚‹ï¼‰
            if (allCandidates.length < 4) {
                 // ç™ºç”Ÿã—ãªã„ã¯ãšã ãŒå¿µã®ãŸã‚
                 return [ {a:5, b:5, answer:10}, {a:6, b:6, answer:12}, {a:7, b:7, answer:14}, {a:8, b:8, answer:16} ];
            }

            // å€™è£œãƒªã‚¹ãƒˆã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã€æœ€åˆã®4å•ã‚’é¸æŠ
            // Fisher-Yates (Knuth) Shuffle
            for (let i = allCandidates.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allCandidates[i], allCandidates[j]] = [allCandidates[j], allCandidates[i]];
            }

            // 4å•ã‚’ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªå•é¡Œã¨ã—ã¦é¸ã¶
            const selectedPairs = allCandidates.slice(0, 4);
            
            // æœ€å¾Œã«ã€Aã¨Bã®è¡¨ç¤ºé †ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å…¥ã‚Œæ›¿ãˆã¦ã€å•é¡Œã®è¦‹ãŸç›®ã‚’å¤šæ§˜ã«ã™ã‚‹
            return selectedPairs.map(q => {
                if (Math.random() < 0.5 && q.a !== q.b) {
                    return { a: q.b, b: q.a, answer: q.answer };
                }
                return q;
            });
        }


        // --- 6. ã‚¿ã‚¤ãƒãƒ¼ã¨ã‚²ãƒ¼ãƒ å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯ ---

        function startTimer() {
            startTime = performance.now();
            const timerElement = document.getElementById('timerDisplay');
            if (timerElement) {
                timerElement.textContent = '0.00 ç§’';
                clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    const elapsedTime = (performance.now() - startTime) / 1000;
                    timerElement.textContent = `${elapsedTime.toFixed(2)} ç§’`;
                }, 10); // 10ãƒŸãƒªç§’ã”ã¨ã«æ›´æ–°
            }
        }

        function stopTimer() {
            clearInterval(timerInterval);
            const endTime = performance.now();
            return (endTime - startTime) / 1000; // ç§’ã‚’è¿”ã™
        }

        function nextQuestion() {
            const inputElement = document.getElementById('answerInput');
            const currentQuestion = questions[currentQuestionIndex];
            const userAnswer = parseInt(inputElement.value.trim());
            const feedbackElement = document.getElementById('feedbackMessage');
            
            // å…¥åŠ›ãƒã‚§ãƒƒã‚¯
            if (isNaN(userAnswer) || inputElement.value.trim() === '') {
                 feedbackElement.textContent = 'æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼';
                 feedbackElement.classList.remove('hidden');
                 return;
            }
            feedbackElement.classList.add('hidden');

            // æ­£èª¤åˆ¤å®š
            if (userAnswer === currentQuestion.answer) {
                // æ­£è§£ï¼
                currentQuestionIndex++;
                inputElement.value = '';
                
                // 4å•å®Œäº†ã®ãƒã‚§ãƒƒã‚¯
                if (currentQuestionIndex >= 4) {
                    const finalTime = stopTimer();
                    const score = 4; // å¸¸ã«4å•æ­£è§£ã¨ã—ã¦æ‰±ã†
                    
                    // çµæœç”»é¢ã¸é·ç§»
                    displayScreen(Screen.RESULT, { score, time: finalTime });

                } else {
                    // æ¬¡ã®å•é¡Œã¸
                    renderPracticeQuestion();
                }

            } else {
                // ä¸æ­£è§£ï¼
                showNotification('ã¡ãŒã„ã¾ã™ï¼ã‚‚ã†ä¸€åº¦è€ƒãˆã¦ã¿ã¦ã­ã€‚', 'error');
                inputElement.value = ''; // å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
                inputElement.focus();
            }
        }

        function renderPracticeQuestion() {
            const questionElement = document.getElementById('questionText');
            const progressElement = document.getElementById('progressText');
            const inputElement = document.getElementById('answerInput');

            if (currentQuestionIndex < questions.length) {
                const q = questions[currentQuestionIndex];
                questionElement.innerHTML = `<span class="text-6xl font-extrabold text-gray-900">${q.a} + ${q.b}</span> =`;
                progressElement.textContent = `å•é¡Œ ${currentQuestionIndex + 1} / 4`;
                inputElement.focus();
            }
        }

        // --- 7. UIæç”»é–¢æ•° (å„ç”»é¢) ---

        // é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
        function showNotification(message, type = 'success') {
            const feedback = document.getElementById('feedbackMessage');
            if (!feedback) return;
            feedback.textContent = message;
            feedback.classList.remove('hidden', 'text-green-600', 'text-red-600', 'text-yellow-600');

            if (type === 'error') {
                feedback.classList.add('text-red-600');
            } else if (type === 'warning') {
                feedback.classList.add('text-yellow-600');
            } else {
                 feedback.classList.add('text-green-600');
            }
            setTimeout(() => {
                feedback.classList.add('hidden');
            }, 3000);
        }

        // ç™»éŒ²ç”»é¢
        function renderRegisterScreen() {
            screenContainer.innerHTML = `
                <div class="text-center p-4">
                    <h2 class="text-2xl font-bold mb-4 text-blue-700">ã‚ˆã†ã“ãï¼ãƒãƒ³ãƒ‰ãƒ«ãƒãƒ¼ãƒ ã‚’ç™»éŒ²</h2>
                    <p class="mb-6 text-gray-600">è¨˜éŒ²ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã«ã€å¥½ããªåå‰ï¼ˆãƒãƒ³ãƒ‰ãƒ«ãƒãƒ¼ãƒ ï¼‰ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>
                    <input type="text" id="handleNameInput" placeholder="ä¾‹: ã•ã‚“ã™ã†ãƒã‚¹ã‚¿ãƒ¼" class="w-full p-3 border-2 border-blue-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg shadow-inner" maxlength="20">
                    <button id="registerButton" class="mt-6 w-full py-3 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-lg transition duration-200 shadow-md">
                        ç™»éŒ²ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆ
                    </button>
                    <p id="feedbackMessage" class="text-red-600 mt-3 hidden"></p>
                </div>
            `;
            document.getElementById('handleNameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('registerButton').click();
                }
            });
            document.getElementById('registerButton').addEventListener('click', () => {
                const input = document.getElementById('handleNameInput');
                const name = input.value.trim();
                if (name.length < 1) {
                    showNotification('ãƒãƒ³ãƒ‰ãƒ«ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
                    return;
                }
                saveHandleName(name);
            });
            
            // ä»¥å‰ã«å…¥åŠ›ãŒã‚ã‚Œã°åˆæœŸå€¤ã¨ã—ã¦è¨­å®š
            if (handleName) {
                document.getElementById('handleNameInput').value = handleName;
            }
        }

        // ãƒ›ãƒ¼ãƒ ç”»é¢
        function renderHomeScreen() {
            const { personalBest, dailyBest, dailyBestUser } = getBestTimes();

            screenContainer.innerHTML = `
                <div class="text-center p-4">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">æŒ‘æˆ¦ã‚’å¾…ã£ã¦ã„ã‚‹ã‚ˆï¼</h2>
                    
                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <!-- å€‹äººãƒ™ã‚¹ãƒˆ -->
                        <div class="bg-blue-50 p-4 rounded-xl shadow-lg border-l-4 border-blue-500">
                            <p class="text-sm font-semibold text-blue-700">ğŸ† å€‹äººã®æœ€é«˜ã‚¿ã‚¤ãƒ </p>
                            <p id="personalBestTime" class="text-3xl font-extrabold text-blue-900 mt-1">
                                ${personalBest !== null ? `${personalBest.toFixed(2)} ç§’` : '---'}
                            </p>
                        </div>
                        <!-- ãƒ‡ã‚¤ãƒªãƒ¼ãƒ™ã‚¹ãƒˆ -->
                        <div class="bg-yellow-50 p-4 rounded-xl shadow-lg border-l-4 border-yellow-500">
                            <p class="text-sm font-semibold text-yellow-700">ğŸŒŸ ä»Šæ—¥ã®æœ€é«˜ã‚¿ã‚¤ãƒ </p>
                            <p id="dailyBestTime" class="text-3xl font-extrabold text-yellow-900 mt-1">
                                ${dailyBest !== null ? `${dailyBest.toFixed(2)} ç§’` : '---'}
                            </p>
                            <p id="dailyBestUser" class="text-xs text-yellow-600 mt-1">
                                ${dailyBestUser !== null ? `by ${dailyBestUser}` : ''}
                            </p>
                        </div>
                    </div>

                    <button id="startButton" class="w-full py-4 bg-green-500 hover:bg-green-600 text-white text-xl font-bold rounded-xl transition duration-300 shadow-lg transform hover:scale-[1.02]">
                        ğŸ”¥ ç·´ç¿’ã‚¹ã‚¿ãƒ¼ãƒˆ (4å•)
                    </button>
                    
                    <button id="changeNameButton" class="mt-4 w-full py-2 text-sm text-gray-500 hover:text-gray-700 transition duration-200">
                        ãƒãƒ³ãƒ‰ãƒ«ãƒãƒ¼ãƒ ã‚’å¤‰æ›´
                    </button>
                </div>
            `;
            document.getElementById('startButton').addEventListener('click', () => {
                questions = generateQuestions();
                currentQuestionIndex = 0;
                displayScreen(Screen.PRACTICE);
                startTimer();
            });
            document.getElementById('changeNameButton').addEventListener('click', () => {
                displayScreen(Screen.REGISTER);
            });
        }

        // ç·´ç¿’ç”»é¢
        function renderPracticeScreen() {
            screenContainer.innerHTML = `
                <div class="text-center p-4">
                    <p id="progressText" class="text-lg font-semibold text-blue-600 mb-6">å•é¡Œ 1 / 4</p>
                    
                    <!-- ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤º -->
                    <div class="bg-gray-100 p-3 rounded-lg shadow-inner mb-8">
                        <p class="text-sm text-gray-500">çµŒéæ™‚é–“</p>
                        <p id="timerDisplay" class="text-4xl font-mono font-bold text-gray-800">0.00 ç§’</p>
                    </div>

                    <!-- å•é¡Œè¡¨ç¤º -->
                    <div class="flex justify-center items-center space-x-4 mb-8">
                        <span id="questionText" class="text-6xl font-extrabold text-gray-900"></span>
                        <input type="number" id="answerInput" class="w-28 p-4 text-4xl text-center border-4 border-blue-400 rounded-xl focus:ring-blue-600 focus:border-blue-600 shadow-lg transition duration-200" placeholder="ç­”ãˆ" inputmode="numeric">
                    </div>

                    <button id="nextButton" class="w-full py-3 bg-blue-500 hover:bg-blue-600 text-white text-xl font-bold rounded-xl transition duration-200 shadow-md">
                        è§£ç­”ã‚’ãƒã‚§ãƒƒã‚¯
                    </button>
                    
                    <p id="feedbackMessage" class="text-red-600 mt-4 text-sm font-semibold hidden"></p>
                    
                    <button id="stopButton" class="mt-4 py-2 text-sm text-gray-500 hover:text-red-500 transition duration-200">
                        é€”ä¸­ã§ã‚„ã‚ã‚‹
                    </button>
                </div>
            `;
            document.getElementById('answerInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('nextButton').click();
                }
            });
            document.getElementById('nextButton').addEventListener('click', nextQuestion);
            document.getElementById('stopButton').addEventListener('click', () => {
                stopTimer();
                currentQuestionIndex = 0;
                questions = [];
                displayScreen(Screen.HOME);
            });

            // æœ€åˆã®å•é¡Œã‚’æç”»
            renderPracticeQuestion();
        }

        // çµæœç”»é¢
        async function renderResultScreen({ score, time }) {
            
            // è¨˜éŒ²ã‚’å…ˆã«ä¿å­˜
            const isSaved = await saveRecord(score, time);
            
            const { personalBest, dailyBest, dailyBestUser } = getBestTimes();
            
            // é”æˆçŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
            let messageTitle = 'ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼';
            let messageBody = `4å•ã‚’**${time.toFixed(2)}ç§’**ã§ã‚¯ãƒªã‚¢ï¼`;
            let messageIcon = 'ğŸ‘';

            let isPersonalBest = personalBest === null || time < personalBest;
            // ãƒ‡ã‚¤ãƒªãƒ¼ãƒ™ã‚¹ãƒˆæ›´æ–°ãƒã‚§ãƒƒã‚¯ (ãƒ‡ã‚¤ãƒªãƒ¼ãƒ™ã‚¹ãƒˆã®è¨˜éŒ²è€…ãŒè‡ªåˆ†ã€ã‹ã¤ã€ç¾åœ¨ã®ã‚¿ã‚¤ãƒ ãŒãã®æ—¥ã®ãƒ™ã‚¹ãƒˆã¨åŒã˜ã‹ã‚ˆã‚Šé€Ÿã„å ´åˆ)
            let isDailyBest = dailyBest === null || (time <= dailyBest && dailyBestUser === handleName);

            // ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã€æ”¹ã‚ã¦ãƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã‚’å–å¾—
            // è¨˜éŒ²ä¿å­˜ã®`await`ãŒå®Œäº†ã—ã¦ã„ã‚‹ã®ã§ã€å†åº¦`getBestTimes`ã‚’å‘¼ã³å‡ºã—ã¦æœ€æ–°ã®ãƒ™ã‚¹ãƒˆã‚’ç¢ºèª
            const newBestTimes = getBestTimes();
            isPersonalBest = newBestTimes.personalBest !== null && time <= newBestTimes.personalBest;
            isDailyBest = newBestTimes.dailyBest !== null && time <= newBestTimes.dailyBest && newBestTimes.dailyBestUser === handleName;


            if (isPersonalBest && isDailyBest) {
                messageTitle = 'ğŸ‰ Wãƒ™ã‚¹ãƒˆé”æˆï¼ãŠã‚ã§ã¨ã†ï¼ ğŸ‰';
                messageBody = `<span class="text-xl">ã™ã”ã™ãã‚‹ï¼å€‹äººã®æœ€é«˜è¨˜éŒ²ã¨ä»Šæ—¥ã®æœ€é«˜è¨˜éŒ²ã‚’åŒæ™‚ã«æ›´æ–°ã—ãŸã‚ˆï¼</span>`;
                messageIcon = 'ğŸŒŸğŸ‘‘';
            } else if (isPersonalBest) {
                messageTitle = 'ğŸ‘‘ è‡ªå·±ãƒ™ã‚¹ãƒˆæ›´æ–°ï¼ãŠã‚ã§ã¨ã†ï¼ ğŸ‘‘';
                messageBody = `<span class="text-xl">ã‚„ã£ãŸã­ï¼å›ã®ä»Šã¾ã§ã®è¨˜éŒ²ã‚’å¡—ã‚Šæ›¿ãˆãŸã‚ˆï¼</span>`;
                messageIcon = 'ğŸš€';
            } else if (isDailyBest) {
                messageTitle = 'ğŸ† ä»Šæ—¥ã®ãƒˆãƒƒãƒ—ã‚¹ã‚³ã‚¢ï¼ ğŸ†';
                messageBody = `<span class="text-xl">ã‚¯ãƒ©ã‚¹ã§ä¸€ç•ªé€Ÿã„ã‚¿ã‚¤ãƒ ã ã‚ˆï¼ã¿ã‚“ãªã«è‡ªæ…¢ã—ã‚ˆã†ï¼</span>`;
                messageIcon = 'ğŸ¥‡';
            }
            
            screenContainer.innerHTML = `
                <div class="text-center p-6 bg-green-50 rounded-xl shadow-inner border-4 border-green-300">
                    <div class="text-6xl mb-4">${messageIcon}</div>
                    <h2 class="text-3xl font-extrabold mb-2 text-green-700">${messageTitle}</h2>
                    <p class="text-lg text-gray-600 mb-6">${messageBody}</p>

                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 inline-block">
                        <p class="text-sm font-semibold text-gray-500">ã‚ãªãŸã®ã‚¿ã‚¤ãƒ </p>
                        <p class="text-5xl font-extrabold text-green-600">${time.toFixed(2)} ç§’</p>
                        <p class="text-lg text-gray-700 mt-2">æ­£ç­”æ•°: ${score} / 4 å•</p>
                    </div>

                    <button id="backToHomeButton" class="mt-8 w-full py-3 bg-blue-500 hover:bg-blue-600 text-white text-lg font-bold rounded-xl transition duration-200 shadow-lg">
                        ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
                    </button>
                    ${!isSaved ? '<p class="text-red-500 mt-3 text-sm">â€»è¨˜éŒ²ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>' : ''}
                </div>
            `;
            document.getElementById('backToHomeButton').addEventListener('click', () => {
                displayScreen(Screen.HOME);
            });
        }

        // --- 8. ã‚¢ãƒ—ãƒªã®èµ·å‹• ---
        initializeFirebase();

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸç”»é¢
        document.addEventListener('DOMContentLoaded', () => {
             // èªè¨¼å®Œäº†æ™‚ã«ç”»é¢ã¯åˆ‡ã‚Šæ›¿ã‚ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è¡¨ç¤º
             screenContainer.innerHTML = '<div class="text-center p-10"><p class="text-gray-500">ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¦ã„ã¾ã™...</p></div>';
        });

    </script>
</body>
</html>